#!/usr/bin/env bun

import { accessSync, constants } from 'node:fs';
import { dirname, join, normalize, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import process from 'node:process';

const scriptDir = normalize(dirname(fileURLToPath(import.meta.url)));
const repoRoot = normalize(resolve(scriptDir, '..'));
const runnerPath = join(repoRoot, 'runner');
const gitBinary = findRealGitBinary();

if (!gitBinary) {
  console.error('Unable to locate the system git binary outside the Sweetistics git shim.');
  process.exit(1);
}

const proc = Bun.spawn([runnerPath, gitBinary, ...process.argv.slice(2)], {
  stdin: 'inherit',
  stdout: 'inherit',
  stderr: 'inherit',
  env: process.env,
});

process.exit(await proc.exited);

function findRealGitBinary(): string | null {
  const skipDirs = new Set([scriptDir, repoRoot]);

  const pathCandidates = (process.env.PATH ?? '')
    .split(':')
    .map((segment) => segment.trim())
    .filter((segment) => segment.length > 0);

  for (const segment of pathCandidates) {
    const normalized = normalize(resolve(segment));
    if (skipDirs.has(normalized)) {
      continue;
    }
    const candidate = join(normalized, 'git');
    if (isExecutable(candidate)) {
      return candidate;
    }
  }

  for (const fallback of ['/usr/bin/git', '/usr/local/bin/git', '/opt/homebrew/bin/git']) {
    if (isExecutable(fallback)) {
      return fallback;
    }
  }

  return null;
}

function isExecutable(candidate: string): boolean {
  try {
    accessSync(candidate, constants.X_OK);
    return true;
  } catch {
    return false;
  }
}

